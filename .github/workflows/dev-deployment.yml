name: dev-server-deployment

on:
  push:
    branches:
    - dev-deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: mkdir ~/.keys
      - run: touch ~/.keys/CSPI_KEY.pem
      - run: echo "${{secrets.CSPI_KEY}}" >> ~/.keys/CSPI_KEY.pem &&  chmod 400 ~/.keys/CSPI_KEY.pem 
      - run: cat ~/.keys/CSPI_KEY.pem
      - name: entering dev vm
        run: |
            ssh -i ~/.keys/CSPI_KEY.pem -o StrictHostKeyChecking=no  ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
              cd general-api-handler-cooperativa
              git pull
              cargo build ---release
              sudo docker compose -f init-server.yml down
              sudo docker compose -f init-server.yml up --build -d
            EOF
